<!doctype html>
<html lang="en_NZ">
<head>
    <meta charset="utf-8"/>
    <title>IRMA attribute verification example</title>

    <!--    <link rel="stylesheet" type="text/css" href="style-membership.css">-->

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <script src="irma.js" defer></script>
    <script type="text/javascript">
      const AWS_IRMA_SERVER = 'http://13.54.7.159:8088';
      const IRMA_SERVER = AWS_IRMA_SERVER;
      const AUTH_METHOD_TOKEN = 'token';
      const AUTH_METHOD = 'publickey'
      const REQUESTER_NAME = 'issuer'
      const PRIVATE_TOKEN = 'secret-fake-token';
      const PRIVATE_KEY = `-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAx3afG0L1zuU/sNRym8uAhI90u3KsHuwsAuuunzipN5AIaUjt
w7AltEf+AdGD0ybjak1g/dXz5BirOYmd7l2RifgoF42cxWnV0Ft6AL2D52LMbFwH
ElYs+mSfJszuMi+XNB2qJtUMrKxzSBlvVXGpU0ScAIG3bWQrughMsprpMwvuHIsZ
7aL/Jg+EK37nxWkl6afTfRhC4unK4vADq3qbX4hWPvoq6gmO7yz6130bAaB5ZFb7
F1Z6wD/n9qHOu70H9MB/HPE1XDblooxMrmr611GcW5GIDgM2ShD90ZQzE2QYiY4L
X4XYd+Su1sGAjgdTQtO7LCK+ze7YSwQMA2NMbQIDAQABAoIBAE4SjCxrhTM6YDei
sEly2hcI37QPKnfgEUoDXhJMZ0+sPN6ZARe7dsad9zpW+7ZGXnVZXEF+4TvCvCKF
Tx/h1/mc/HRbpaVPy7UGWTa490w2S7WOP+ZZfLl1cSYKyKE0J4bqpZMViSR9S5JJ
Al77Yj+Jd1Zrb5SNxN/IJ90w7V5g90dSy8D2uISkJpNUZkXJfsATzavRNvv3kYmC
PsZQAdMBkPBm4niwVn4wZX3HSLokrotqYv62nYWGJtKy7JXV0FhScoYLvX6vf3YB
u1xMuPsdRFQ6VJluJN3tu57xcAbS2wx0roItgG5p0UB7bo6rWjFp5OOLMYFy883g
IzhLvIECgYEA+apyb2MdCqTN/4gFjVZitRRkHuDQJUarpJ93v5hwW5b0LnNvHSc+
0zsH6kg7qogqr7bhqCA2pQbCTT2tiaGuBwDfi72IijcsRQflNf3/eaEoRMtpSOwc
3Jphnw0lIc1FWS/D1V8sGEUhZxnASCyPwonAZ/5qcsLy7PrCvZXmqyUCgYEAzIYd
bP0Q266EbhbuBS9bV8nIQj8fQCsWS53tn+wXYZCUHbdEIQvGjMYUV4ODAEm+MaAd
t8oeoowQ8Q8AfgTCBK8H190XR0iE/1ER+lORVcgK7ew5PmqQlOKis08PypMsvYV2
wDZH68AsT2txj8g9PDT7oUkafLKZWM2Fb+AavakCgYBMRFk41ZolijqzeKXZiy4U
Cuqa1CpBeNkuLNiz2qlYEUD+f5zN1xNGC55bXz161qXTj5ZXeZ+3wdzRI6pDhPRY
h1fCpF91eW04mTTXzYOhcC2Q9mJvOFGIwlBX+fgB32bz27eDEtOxhkyx5hfq9FHm
J5ZzLjDuZcc3xVJ//667UQKBgQC3175Pn9MthVvpEZd29bCn4uuuEMtohNKPujBF
VpVVz/40D+6fvdQF6m+SktaIxcC/HuxXrsmG11zLMu8AWAqG50anlUc9fkR+tELy
v3eeoiig4Xw7TNMV4fraLzFEqLLI0VWDRce0dJPf9/amhhn1KrMdsXarrGcHWgae
H9YpsQKBgQC0nbIuT2vcI268JAVZ6vBoCiHMNVlXZMi5n4KxjQaoXX2IuAtvstXD
7BpTWazmP3HmRTNsTUWfyFWQ477I3DtgCOY3BVP8vZ4RbwHA8fqJ3BvfasWhzjs+
KaF7k7n+mTKfeYkPbnj16w/+3q7s0L1IBZ2W6XsvpgYh+nkJGSEYHg==
-----END RSA PRIVATE KEY-----`;

      const ATTRIBUTE = {
        FAKE_REALME_EMAIL: 'inz-demo.fake-realme.email.email',
        FAKE_INTERNALAFFAIRS_NAME: 'inz-demo.fake-internalaffairs.name.fullName',
      };

      let userMembershipAttributes = {};

      function doVerificationSession() {
        const attr = document.getElementById('attr').value;
        const label = document.getElementById('label').value;
        const message = document.getElementById('message').value;
        const labelRequest = !label ? {} : {'labels': {'0': {'en': label, 'nl': label}}};
        const request = !message ? {
          '@context': 'https://irma.app/ld/request/disclosure/v2',
          'disclose': [
            [
              [attr]
            ]
          ],
          ...labelRequest
        } : {
          '@context': 'https://irma.app/ld/request/signature/v2',
          'message': message,
          'disclose': [
            [
              [attr]
            ]
          ],
          ...labelRequest
        };
        doSession(request).then(function (result) {
          showSuccess('Success, attribute value: <strong>' + result.disclosed[0][0].rawvalue + '</strong>');
        });
      }

      function discloseOrSign(attribute, label = '', message = '') {
        //const attr = document.getElementById('attr').value;
        //const label = document.getElementById('label').value;
        //const message = document.getElementById('message').value;
        const labelRequest = !label ? {} : {'labels': {'0': {'en': label, 'nl': label}}};
        const request = !message ? {
          '@context': 'https://irma.app/ld/request/disclosure/v2',
          'disclose': [
            [
              [attribute]
            ]
          ],
          ...labelRequest
        } : {
          '@context': 'https://irma.app/ld/request/signature/v2',
          'message': message,
          'disclose': [
            [
              [attribute]
            ]
          ],
          ...labelRequest
        };
        return doSession(request).then(function (result) {
          showSuccess('Success, attribute value: <strong>' + result.disclosed[0][0].rawvalue + '</strong>');
          return getDiscloseResultRawValue(result);
        });
      }

      function doIssuanceSession() {
        const attrs = document.getElementById('newattrs').value;
        const fullCredential = document.getElementById('newcredential').value;
        const attribute = fullCredential.split('.').pop();
        const credential = fullCredential.replace(`.${attribute}`, '');
        let attributes = {[attribute]: attrs};
        if (fullCredential === 'inz-demo.internetnz.membership.id') {
          attributes = {
            id: document.getElementById('newattrs').value,
            type: 'Personal',
            purchaseDate: '01/01/2020',
            renewalDate: '01/01/2020',
            validUntil: '01/02/2021',
          };
        }
        doSession({
          '@context': 'https://irma.app/ld/request/issuance/v2',
          'credentials': [{
            'credential': credential,
            'attributes': attributes
          }]
        }).then(function (result) {
          showSuccess('Success');
        });
      }

      function doSession(request) {
        clearOutput();
        showSuccess('Demo running...');

        const server = IRMA_SERVER;
        const authmethod = AUTH_METHOD_TOKEN;
        const key = PRIVATE_TOKEN;
        const requestorname = '';

        return irma.startSession(server, request, authmethod, key, requestorname)
          .then(function (pkg) {
            return irma.handleSession(pkg.sessionPtr, {server: server, token: pkg.token, method: 'popup', language: 'en'});
          })
          .then(function (result) {
            console.log('Done', result);
            return result;
          })
          .catch(function (err) {
            showError(err);
          });
      }

      // UI handling functions
      function clearOutput() {
        const e = document.getElementById('result');
        e.setAttribute('hidden', 'true');
        e.classList.remove('succes', 'warning', 'error');
      }

      function showError(err) {
        const e = document.getElementById('result');
        e.removeAttribute('hidden');
        e.classList.remove('success');
        if (err === irma.SessionStatus.Cancelled) {
          e.classList.add('warning');
          e.innerText = 'Session was aborted';
        } else {
          e.classList.add('error');
          e.innerText = 'Error occurred: ' + String(err);
        }
        throw err;
      }

      function showSuccess(text) {
        const e = document.getElementById('result');
        e.innerHTML = text;
        e.removeAttribute('hidden');
        e.classList.add('alert-success');
      }

      function hideElements() {
        for (let i = 0; i < arguments.length; i++) document.getElementById(arguments[i]).setAttribute('hidden', 'true');
      }

      function showElements() {
        for (let i = 0; i < arguments.length; i++) document.getElementById(arguments[i]).removeAttribute('hidden');
      }

      const clearUserMembershipAttributes = function () {
        userMembershipAttributes = {};
      };

      // const setUserMembershipAttribute = function (attribute, value) {
      //   userMembershipAttributes[attribute] = value;
      //   console.info('---UPDATED---');
      //   console.info(userMembershipAttributes);
      // };

      const getDiscloseResultRawValue = function (result) {
        console.log(result);
        return result.disclosed[0][0].rawvalue || '';
      };

      window.onload = function () {
        let app = new Vue({
          el: '#app',
          data: {
            message: 'Hello Vue!',
            userMembershipAttributes: {
              email: null,
              name: null
            }
          },
          methods: {
            verifyFakeRealMeEmail: function () {
              console.log('verifyFakeRealMeEmail');
              return discloseOrSign(ATTRIBUTE.FAKE_REALME_EMAIL)
                .then((result) => {
                  app.userMembershipAttributes.email = result;
                });
            },

            verifyFakeInternalAffairsName: function () {
              console.log('verifyFakeInternalAffairsName');
              return discloseOrSign(ATTRIBUTE.FAKE_INTERNALAFFAIRS_NAME)
                .then((result) => {
                  app.userMembershipAttributes.name = result;
                });
            }
          }
        })
      };
    </script>
</head>
<body>
<div id="app" class="container">
    <h1>INZ Membership demo (based on IRMA)</h1>

    <div id="appsss">
        {{ message }}
    </div>

    <p>
        This page contains an INZ attribute issuance and verification demo.
    </p>

    <div id="result" class="status alert" hidden></div>

    <h2>E-mail</h2>
    <p>
        <button id="verify-fakerealme-email" class="btn btn-info" v-on:click="verifyFakeRealMeEmail()">Verify Fake RealMe E-mail</button>
    </p>

    <h2 v-if="userMembershipAttributes.email">Name</h2>
    <p v-if="userMembershipAttributes.email">
        <button id="verify-fakeinternalaffairs-name" class="btn btn-info" v-on:click="verifyFakeInternalAffairsName()">Verify Fake Internal Affairs Full Name</button>
    </p>

    <div v-if="userMembershipAttributes.email && userMembershipAttributes.name">
        <form>
            <legend>Membership</legend>
            <div class="form-group row">
                <label for="staticEmail" class="col-sm-2 col-form-label">Email</label>
                <div class="col-sm-10">
                    <input type="text" readonly class="form-control" id="staticEmail" v-model="userMembershipAttributes.email">
                </div>
            </div>
            <div class="form-group row">
                <label for="name" class="col-sm-2 col-form-label">Name</label>
                <div class="col-sm-10">
                    <input type="text" readonly class="form-control" id="name" v-model="userMembershipAttributes.name">
                </div>
            </div>
            <fieldset class="form-group">
                <div class="row">
                    <legend class="col-form-label col-sm-2 pt-0">Type</legend>
                    <div class="col-sm-10">
                        <div class="form-check">
                            <input
                                    class="form-check-input" type="radio" name="gridRadios" id="gridRadios1" value="Individual"
                                    v-model="userMembershipAttributes.type"
                            >
                            <label class="form-check-label" for="gridRadios1">
                                Individual
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="gridRadios" id="gridRadios2" value="Organization"
                                   v-model="userMembershipAttributes.type"
                            >
                            <label class="form-check-label" for="gridRadios2">
                                Organization
                            </label>
                        </div>

                        <br>
                        <select class="custom-select" required
                                v-if="userMembershipAttributes.type === 'Individual'">
                            <option value="">Open this select menu</option>
                            <option value="1">Individual - 1 year</option>
                            <option value="5">Individual - 5 year</option>
                            <option value="10">Individual - 10 years</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <div class="form-group row">
                <label for="staticEmail" class="col-sm-2 col-form-label">&nbsp;</label>
                <div class="col-sm-10">
                    <button>Save</button>
                </div>
            </div>
        </form>
    </div>

    <div>
        {{ userMembershipAttributes }}
    </div>

</div>
</body>
</html>
