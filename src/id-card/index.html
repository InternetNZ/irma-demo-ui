<!doctype html>
<html lang="en-NZ">
<head>
    <title>InternetNZ | IRMA examples - ID-Card</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        [v-cloak] {
            display: none;
        }
    </style>

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="assets/css/style-id-card.css" rel="stylesheet">

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <!-- development version, includes helpful console warnings -->
    <script src="https://unpkg.com/vue@next"></script>

    <script src="../assets/lib/irma-0.3.3.js" defer></script>
    <script src="../assets/lib/luxon-1.26.0.min.js" defer></script>
    <script src="../assets/js/irma-functions.js" defer></script>
    <script src="../assets/js/ui-functions.js" defer></script>
    <script src="../assets/js/api-service.js" defer></script>
    <script src="../assets/js/global.js">
        // --------------------------------
        // globals loaded from globals file
        // --------------------------------
    </script>
    <script type="text/javascript">
        window.onload = function () {
            const IdCardApp = {
                data() {
                    return {
                        // credentials
                        email: '',
                        fullName: '',
                        over18: null,
                        agelimit: null,
                        // controls
                        formBase64Image: null,
                        formDocumentType: null,
                        statusMessage: null,
                        statusMessageClass: null,
                        finished: false,
                        idCardToIssue: null,
                        logged: false,
                        loggedUser: {},
                        purchaseMode: null,
                        requestInProgress: false,
                    }
                },
                methods: {
                    createBase64Image(fileObject) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.formBase64Image = e.target.result.split(';').pop().replace('base64,', '');
                        };
                        reader.readAsDataURL(fileObject);
                    },
                    handleImage(e) {
                        const selectedImage = e.target.files[0];
                        this.createBase64Image(selectedImage);
                    },
                    login() {
                        this.messageClear();
                        const toDisclose = new DiscloseQueryGenerator()
                            .forAttribute(ATTRIBUTE.FAKE_PERSONAL_DATA_PERSON_NAME.FULL_NAME)
                            .andAttribute(ATTRIBUTE.FAKE_EMAILER_EMAIL.EMAIL);

                        irmaDiscloseOrSign(toDisclose.toApi(), 'Please, provide your Name and Email')
                            .then((result) => {
                                this.logged = true;
                                this.loggedUser = {
                                    name: irmaDisclosedResultSingleRawValueFromIndex(result, 0),
                                    email: irmaDisclosedResultSingleRawValueFromIndex(result, 1),
                                };

                                this.messageClear();
                            })
                            .catch((error) => {
                                this.logged = false;
                                this.loggedUser = null;
                                this.messageError(error);
                            })
                    },
                    makeIdCardToIssueFromDocument(document) {
                        luxon.Settings.defaultLocale = LOCALE_NZ;

                        const now = luxon.DateTime.now().toUTC();
                        const validity = now.plus({months: 1}).toUTC();
                        const expiryDate = now.plus({years: 10});
                        const birthDate = luxon.DateTime.fromFormat(document.birthDate, 'yyyy-MM-dd').toUTC();
                        this.idCardToIssue = {
                            firstName: document.givenNames,
                            lastName: document.familyName,
                            fullName: `${document.givenNames} ${document.familyName}`,
                            birthdate: birthDate.toLocaleString(),
                            over18: this.overAge(birthDate, 18),
                            over20: this.overAge(birthDate, 20),
                            over65: this.overAge(birthDate, 65),
                            issueDate: now.toLocaleString(),
                            expiryDate: expiryDate.toLocaleString(),
                            number: `${now.toMillis()}`,
                            validity: parseInt(validity.toSeconds()),
                        };
                    },
                    messageClear() {
                        this.statusMessage = null;
                        this.statusMessageClass = null;
                    },
                    messageInfo(message) {
                        this.statusMessage = message;
                        this.statusMessageClass = 'alert-info';
                    },
                    messageError(message) {
                        if (message === 'Aborted') {
                            message = 'Session was aborted';
                        } else {
                            message = `Error: ${message}`;
                        }

                        this.statusMessage = message;
                        this.statusMessageClass = 'alert-danger';
                    },
                    overAge(birthDate, checkAge) {
                        const diff_ms = Date.now() - birthDate.toSeconds();
                        const age_dt = new Date(diff_ms);
                        const age = Math.abs(age_dt.getUTCFullYear() - 1970);

                        return age >= checkAge ? 'Yes' : 'No';
                    },
                    /**
                     *
                     * Result example
                     * {
                     *    "givenName": "Samantha Sam",
                     *    "familyName": "Sample",
                     *    "documentNumber": "BS123456",
                     *    "documentVersion": "757",
                     *    "birthDate": "1978-01-28",
                     *    "dateOfExpiry": "2025-04-15",
                     *    "governmentVerified": "verified",
                     *    "verificationReference": "3d7f9ed3-8bf7-41e8-868b-7cc679a0397f"
                     *  }
                     */
                    processDriverLicenceResult(driverLicenceResult) {
                        const fullname = `${driverLicenceResult.givenNames} ${driverLicenceResult.familyName}`.trim();

                        if (fullname !== this.loggedUser.name) {
                            this.messageError(
                                `Your name "${this.loggedUser.name}" does not match with your driver licence name "${fullname}".`)
                            return;
                        }

                        this.makeIdCardToIssueFromDocument(driverLicenceResult);
                    },
                    /**
                     *
                     * @param passportResult
                     *
                     * Result example
                     * {
                     *      "givenNames": "Sam",
                     *      "familyName": "Specimen",
                     *      "gender": "F",
                     *      "documentNumber": "PA1234567",
                     *      "nationality": "NZL",
                     *      "issuerCountry": "NZL",
                     *      "birthDate": "1990-04-18",
                     *      "dateOfExpiry": "2025-04-18",
                     *      "governmentVerified": "verified",
                     *      "verificationReference": "3d7f9ed3-8bf7-41e8-868b-7cc679a0397f"
                     *  }
                     *
                     */
                    processPassportResult(passportResult) {
                        const fullname = `${passportResult.givenNames} ${passportResult.familyName}`.trim();

                        if (fullname !== this.loggedUser.name) {
                            this.messageError(
                                `Your name "${this.loggedUser.name}" does not match with your passport name "${fullname}".`)
                            return;
                        }

                        this.makeIdCardToIssueFromDocument(passportResult);
                    },
                    reset() {
                        this.finished = false;
                        this.requestInProgress = false;
                        this.logged = false;

                        this.formDocumentType = null;
                        this.idCardToIssue = null;

                        this.loggedUser = {};

                        this.messageClear();
                    },
                    saveIdCard: function () {
                        console.log('saveIdCard');
                        const self = this;
                        return irmaIssueCredential(CREDENTIAL.ID_CARD_ID_CARD, this.idCardToIssue, HEADER_MESSAGES.ISSUE_ID_CARD_ID_CARD)
                            .then((_) => {
                                self.finished = true;
                            }).catch(function (err) {
                                self.messageError(err);
                            });
                    },
                    uploadDocument() {
                        this.requestInProgress = true;

                        if (this.formDocumentType === 'passport') {
                            this.messageInfo('Uploading your passport. Please, wait.');
                            return checkPassport(this.formBase64Image)
                                .then((result) => {
                                    this.requestInProgress = false;
                                    this.messageClear();
                                    return this.processPassportResult(result);
                                })
                                .catch(error => {
                                    this.requestInProgress = false;
                                    this.messageError(error);
                                });
                        } else if (this.formDocumentType === 'driverLicence') {
                            this.messageInfo('Uploading your driver licence...');
                            return checkDriverLicence(this.formBase64Image)
                                .then((result) => {
                                    this.requestInProgress = false;
                                    this.messageClear();
                                    return this.processDriverLicenceResult(result);
                                })
                                .catch(error => {
                                    this.requestInProgress = false;
                                    this.messageError(error);
                                });
                        }

                        this.requestInProgress = false;
                        this.messageError('Error selecting document');
                    },
                }
            };

            Vue.createApp(IdCardApp).mount('#app');
        };
    </script>
</head>
<body>
<div id="app" class="container" v-cloak>

    <header id="header" class="d-flex align-items-center">
        <div class="flex-grow-1">
            <img src="assets/images/Logo_negative.png" title="IDNZCard" alt="IDNZCard">
        </div>
        <div class="flex-shrink-1">
            <img src="assets/images/menu.png" title="IDNZCard" alt="IDNZCard">
        </div>
    </header>

    <div id="div-reset-button" class="text-end">
        <button id="reset-button" class="btn-sm" v-on:click="reset()">
            <img src="assets/images/icon-refresh.png"> Reset demo
        </button>
    </div>

    <div id="step1-first-div" class="row" v-if="!logged">
        <div id="step1-first-div-1">
            <h1>Get your IDNZ digital card.</h1>
            <p style="margin: 24px 0 48px 0">
                Issue a digital version of your IDNZ card into your IRMA wallet or refresh the expiry date of your current digital card.
            </p>

            <div style="margin-left:-16px">
                <button class="btn btn-lg btn-primary" v-on:click="login()">Issue digital card</button>
                <button class="btn btn-lg btn-secondary" v-on:click="refreshExpiryDate()">Refresh expiry date</button>
            </div>

            <div class="mt-4">
                <span class="status alert" v-if="statusMessage" v-bind:class="statusMessageClass" role="alert">
                    <img :src="`assets/images/icon-${statusMessageClass}.png`">
                    {{ statusMessage }}
                </span>
            </div>
        </div>
        <div class="ms-5">
            <img src="assets/images/landing-page.png" height="624" width="602">
        </div>
    </div>

    <!-- Step 2 -->
    <div v-if="logged">
        <div class="row" v-if="statusMessage">
            <div class="status alert col-12" v-bind:class="statusMessageClass" role="alert">{{ statusMessage }}</div>
        </div>

        <div v-if="!idCardToIssue">
            <div class="row">
                <div class="col-12 col-lg-8 col-xl-6">
                    <div id="upload-doc-text">
                        <h3 class="pb-3">Welcome, <span id="logged-name">{{ loggedUser.name.split(' ').shift() }}</span></h3>
                        <h2>
                            Please select and upload your document
                        </h2>
                    </div>
                    <form id="upload">
                        <div class="pt-3 pb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" v-model="formDocumentType" value="passport">
                                <label class="form-check-label" for="inlineRadio1">Passport</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" v-model="formDocumentType" value="driverLicence">
                                <label class="form-check-label" for="inlineRadio2">License</label>
                            </div>
                        </div>
                        <div v-if="formDocumentType">
                            <div class="input-group" id="image-upload">
                                <input type="file" class="form-control" id="inputGroupFile02" accept="image/*" @change="handleImage">
                                <label class="input-group-text" for="inputGroupFile02">Upload</label>
                            </div>
                            <div id="image-file-size" class="mb-3">Maximum file size: 10 MB</div>

                            <div class="col-auto" style="margin-left:-16px" v-if="formBase64Image">
                                <button type="button" class="btn btn-primary btn-lg mb-3"
                                        v-bind:v-disabled="!formBase64Image || requestInProgress"
                                        v-on:click="uploadDocument()">Upload
                                </button>
                            </div>
                        </div>
                        <div class="mt-4">
                                <span class="alert alert-warning" role="alert">
                                    <img src="assets/images/icon-alert-warning.png">
                                    The name on the document should match with
                                    <strong>{{ loggedUser.name }}</strong>
                                </span>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Step 3 -->
        <div v-if="idCardToIssue">
            <h3>Confirmed Information - ID Card</h3>
            <ul>
                <li>Full name: {{ idCardToIssue.fullName }} </li>
                <li>First name: {{ idCardToIssue.firstName }} </li>
                <li>Last name: {{ idCardToIssue.lastName }} </li>
                <li>Date of birth: {{ idCardToIssue.birthdate }} </li>
                <li>Expiry date: {{ idCardToIssue.expiryDate }} </li>
                <li>Issue Date: {{ idCardToIssue.issueDate }} </li>
                <li>Card number: {{ idCardToIssue.number }} </li>
                <li>Over18: {{ idCardToIssue.over18 }} </li>
                <li>Over20: {{ idCardToIssue.over20 }} </li>
                <li>Over65: {{ idCardToIssue.over65 }} </li>
            </ul>

            <button type="button" class="btn btn-success mb-3" v-if="!finished" v-on:click="saveIdCard()">Issue your ID-Card!</button>
        </div>

        <!-- Step 4 -->
        <div v-if="finished">
            <h3>Done</h3>

            <p>Click on reset to start over.</p>
        </div>

    </div>

</div>
</body>
</html>
