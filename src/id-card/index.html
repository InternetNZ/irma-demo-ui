<!doctype html>
<html lang="en-NZ">
<head>
    <title>InternetNZ | IRMA examples - ID-Card</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        [v-cloak] {
            display: none;
        }
    </style>

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <!-- development version, includes helpful console warnings -->
    <script src="https://unpkg.com/vue@next"></script>

    <script src="../assets/irma.js" defer></script>
    <script src="../assets/js/irma-functions.js" defer></script>
    <script src="../assets/js/ui-functions.js" defer></script>
    <script src="../assets/js/api-service.js" defer></script>
    <script src="../assets/js/global.js">
        // --------------------------------
        // globals loaded from globals file
        // --------------------------------
    </script>
    <script type="text/javascript">
        window.onload = function () {
            const IdCardApp = {
                data() {
                    return {
                        // credentials
                        email: '',
                        fullName: '',
                        over18: null,
                        agelimit: null,
                        // controls
                        formBase64Image: null,
                        formDocumentType: null,
                        statusMessage: null,
                        statusMessageClass: null,
                        finished: false,
                        idCardToIssue: null,
                        logged: false,
                        loggedUser: {},
                        purchaseMode: null,
                        requestInProgress: false,
                    }
                },
                methods: {
                    createBase64Image(fileObject) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.formBase64Image = e.target.result.split(';').pop().replace('base64,', '');
                        };
                        reader.readAsDataURL(fileObject);
                    },
                    handleImage(e) {
                        const selectedImage = e.target.files[0];
                        this.createBase64Image(selectedImage);
                    },
                    login() {
                        this.messageInfo('Verifying attributes to login with IRMA');

                        const toDisclose = new DiscloseQueryGenerator()
                            .forAttribute(ATTRIBUTE.FAKE_PERSONAL_DATA_PERSON_NAME.FULL_NAME)
                            .andAttribute(ATTRIBUTE.FAKE_EMAILER_EMAIL.EMAIL);

                        irmaDiscloseOrSign(toDisclose.toApi(), 'Please, provide your Name and Email')
                            .then((result) => {
                                this.logged = true;
                                this.loggedUser = {
                                    name: irmaDisclosedResultSingleRawValueFromIndex(result, 0),
                                    email: irmaDisclosedResultSingleRawValueFromIndex(result, 1),
                                };

                                this.messageClear();
                            })
                            .catch((error) => {
                                this.logged = false;
                                this.loggedUser = null;
                                this.messageError(error);
                            })
                    },
                    makeIdCardToIssueFromDocument(document) {
                        const now = new Date();
                        const expiryDate = new Date(now.getFullYear() + 10, now.getMonth(), now.getDay());
                        const birthDate = new Date(document.birthDate);
                        this.idCardToIssue = {
                            fullName: `${document.givenNames} ${document.familyName}`,
                            firstName: document.givenNames,
                            lastName: document.familyName,
                            birthdate: `${birthDate.getDay()}/${birthDate.getUTCMonth() + 1}/${birthDate.getFullYear()}`,
                            expiryDate: expiryDate.toLocaleDateString(LOCALE_NZ),
                            issueDate: now.toLocaleDateString(LOCALE_NZ),
                            cardNumber: now.getTime(),
                            over18: this.overAge(birthDate, 18),
                            over20: this.overAge(birthDate, 20),
                            over65: this.overAge(birthDate, 65),
                        };
                    },
                    messageClear() {
                        this.statusMessage = null;
                        this.statusMessageClass = null;
                    },
                    messageInfo(message) {
                        this.statusMessage = message;
                        this.statusMessageClass = 'alert-info';
                    },
                    messageError(message) {
                        if (message === 'Aborted') {
                            message = 'Session was aborted';
                        } else {
                            message = `Error: ${message}`;
                        }

                        this.statusMessage = message;
                        this.statusMessageClass = 'alert-danger';
                    },
                    overAge(birthDate, checkAge) {
                        const diff_ms = Date.now() - birthDate.getTime();
                        const age_dt = new Date(diff_ms);
                        const age = Math.abs(age_dt.getUTCFullYear() - 1970);

                        return age >= checkAge ? 'Yes' : 'No';
                    },
                    /**
                     *
                     * Result example
                     * {
                     *    "givenName": "Samantha Sam",
                     *    "familyName": "Sample",
                     *    "documentNumber": "BS123456",
                     *    "documentVersion": "757",
                     *    "birthDate": "1978-01-28",
                     *    "dateOfExpiry": "2025-04-15",
                     *    "governmentVerified": "verified",
                     *    "verificationReference": "3d7f9ed3-8bf7-41e8-868b-7cc679a0397f"
                     *  }
                     */
                    processDriverLicenceResult(driverLicenceResult) {
                        const fullname = `${driverLicenceResult.givenNames} ${driverLicenceResult.familyName}`;

                        if (fullname !== this.loggedUser.name) {
                            this.messageError(
                                `Your name "${this.loggedUser.name}" does not match with your driver licence name "${fullname}".`)
                            return;
                        }

                        this.makeIdCardToIssueFromDocument(driverLicenceResult);
                    },
                    /**
                     *
                     * @param passportResult
                     *
                     * Result example
                     * {
                     *      "givenNames": "Sam",
                     *      "familyName": "Specimen",
                     *      "gender": "F",
                     *      "documentNumber": "PA1234567",
                     *      "nationality": "NZL",
                     *      "issuerCountry": "NZL",
                     *      "birthDate": "1990-04-18",
                     *      "dateOfExpiry": "2025-04-18",
                     *      "governmentVerified": "verified",
                     *      "verificationReference": "3d7f9ed3-8bf7-41e8-868b-7cc679a0397f"
                     *  }
                     *
                     */
                    processPassportResult(passportResult) {
                        const fullname = `${passportResult.givenNames} ${passportResult.familyName}`;

                        if (fullname !== this.loggedUser.name) {
                            this.messageError(
                                `Your name "${this.loggedUser.name}" does not match with your passport name "${fullname}".`)
                            return;
                        }

                        this.makeIdCardToIssueFromDocument(passportResult);
                    },
                    reset() {
                        this.logged = this.finished = this.requestInProgress = false;
                        this.idCardToIssue = this.loggedUser = null;
                        this.messageClear();
                    },
                    uploadDocument() {
                        this.requestInProgress = true;

                        if (this.formDocumentType === 'passport') {
                            this.messageInfo('Uploading your passport. Please, wait.');
                            return checkPassport(this.formBase64Image)
                                .then((result) => {
                                    this.requestInProgress = false;
                                    this.messageClear();
                                    return this.processPassportResult(result);
                                })
                                .catch(error => {
                                    this.requestInProgress = false;
                                    this.messageError(error);
                                });
                        } else if (this.formDocumentType === 'driverLicence') {
                            this.messageInfo('Uploading your driver licence...');
                            return checkDriverLicence(this.formBase64Image)
                                .then((result) => {
                                    this.requestInProgress = false;
                                    this.messageClear();
                                    return this.processDriverLicenceResult(result);
                                })
                                .catch(error => {
                                    this.requestInProgress = false;
                                    this.messageError(error);
                                });
                        }

                        this.requestInProgress = false;
                        this.messageError('Error selecting document');
                    },
                }
            };

            Vue.createApp(IdCardApp).mount('#app');
        };
    </script>
</head>
<body>
<div id="app" class="container" v-cloak>

    <header>
        <h2>ID Card</h2>
        <hr>
    </header>

    <div class="text-end">
        <button class="btn btn-sm btn-outline-secondary" v-on:click="reset()">Reset</button>
    </div>

    <div class="row" v-if="statusMessage">
        <div id="result" class="status alert col-12" v-bind:class="statusMessageClass" role="alert">{{ statusMessage }}</div>
    </div>

    <div>
        <h2>Welcome and get your ID-Card!</h2>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">How to:</h5>
                <div class="card-text">
                    <ol>
                        <li>Login using your IRMA credentials (Name and Email)</li>
                        <li>Upload your Passport or Driver Licence</li>
                        <li>Issue your digital ID Card</li>
                    </ol>
                </div>
            </div>
        </div>
        <br>

        <!-- Step 1 -->
        <div v-if="!logged" class="text-center">
            <button class="btn btn-lg btn-primary" v-on:click="login()">Loging with IRMA</button>
        </div>

        <!-- Step 2 -->
        <div v-if="logged">
            <h4>You are in!</h4>
            <ul>
                <li>Name: <strong>{{ loggedUser.name }}</strong></li>
                <li>Email: <strong>{{ loggedUser.email }}</strong></li>
            </ul>

            <div v-if="!idCardToIssue">
                <h3>Upload your passport or driver license</h3>
                <form id="upload">
                    <div class="alert alert-warning" role="alert">
                        The name on the document should match with
                        <strong>{{ loggedUser.name }}</strong>, otherwise the ID Card will not be issued.
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" v-model="formDocumentType" value="passport">
                        <label class="form-check-label" for="inlineRadio1">Passport</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" v-model="formDocumentType" value="driverLicence">
                        <label class="form-check-label" for="inlineRadio2">License</label>
                    </div>
                    <div v-if="formDocumentType">
                        <div class="input-group mb-3">
                            <input type="file" class="form-control" id="inputGroupFile02" accept="image/*" @change="handleImage">
                            <label class="input-group-text" for="inputGroupFile02">Upload</label>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-primary mb-3"
                                    v-bind:disabled="!formBase64Image || requestInProgress"
                                    v-on:click="uploadDocument()">Send
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Step 3 -->
            <div v-if="idCardToIssue">
                <h3>Confirmed Information - ID Card</h3>
                <ul>
                    <li>Full name: {{ idCardToIssue.fullName }} </li>
                    <li>First name: {{ idCardToIssue.firstName }} </li>
                    <li>Last name: {{ idCardToIssue.lastName }} </li>
                    <li>Date of birth: {{ idCardToIssue.birthdate }} </li>
                    <li>Expiry date: {{ idCardToIssue.expiryDate }} </li>
                    <li>Issue Date: {{ idCardToIssue.issueDate }} </li>
                    <li>Card number: {{ idCardToIssue.cardNumber }} </li>
                    <li>Over18: {{ idCardToIssue.over18 }} </li>
                    <li>Over20: {{ idCardToIssue.over20 }} </li>
                    <li>Over65: {{ idCardToIssue.over65 }} </li>
                </ul>

                <button type="button" class="btn btn-success mb-3" v-on:click="finished = true">Issue your ID-Card!</button>
            </div>

            <!-- Step 4 -->
            <div v-if="finished">
                <div class="alert alert-info" role="alert">
                    Step 4 - Done. The credential should be stored on IRMA App.
                </div>

                <h3>Done</h3>

                <p>Click on reset to start over.</p>
            </div>

        </div>
    </div>

</div>
</body>
</html>
